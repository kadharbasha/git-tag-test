#!/usr/bin/env groovy

def list = ["dir1", "dir2", "dir3", "dir4", "dir5"]
def map = [
    dir1: "1.0.0", 
    dir2: "2.0.1", 
    dir3: "3.2.1",
    dir4: "1.2.3",
    dir4v2: "1.2.3",
    dir5: "4.5.6",
    dir5v2: "1.2.3"
]
def tagname
def tagnumber

pipeline {
    options {
        buildDiscarder(logRotator(numToKeepStr: '6'))
    }
    agent none
    stages {
        stage('buildparallel'){
            parallel{
                stage('Preparing updated services') {
                    agent any
                    steps {
                        script {
                            for(int i=0; i < list.size(); i++) {
                                matches2 = sh (
                                    script: "git diff --name-only HEAD~1 | sort -u | awk -F/ {'print \$3'} | uniq | grep -x 'v2' || git diff-tree --no-commit-id --name-only -r HEAD | sort -u | awk -F/ {'print \$3'} | uniq | grep -x 'v2'", returnStatus: true
                                ) == 0
                                if("$matches2"!="true" && (("$list[i]"=="dir4") || ("$list[i]"=="dir5"))){
                                    stage(list[i] + 'v2 build'){
                                        dir ("services/${list[i]}/v2/build") {
                                            sh "ls -la"
                                            echo "${BRANCH_NAME}"
                                        }
                                    }
                                    //if("${BRANCH_NAME}" == "dev"){
                                        stage(list[i] + 'v2  docker push'){
                                            def noSpec = "${list[i]}".toString().replaceAll("[^a-zA-Z0-9 ]+","")
                                            echo "${noSpec}v2" 
                                            for (element in map) {
                                                if("${element.key}" == "${noSpec}v2"){
                                                    tagname = "${element.key}"
                                                    echo "$tagname"
                                                    tagnumber = "${element.value}"
                                                    echo "$tagname"
                                                    break
                                                }
                                            }
                                            dir ("services/${list[i]}/v2/build") {
                                                sh "docker images"
                                                sh "docker build -f build/dockerfile -t 31147669.dkr.ecr.us-east-1.amazonaws.com/ss01-prod-${tagname}:${tagnumber} ."
                                                sh "docker build -f build/dockerfile -t 31147669.dkr.ecr.us-east-1.amazonaws.com/ss01-prod-maxapi-${tagname}-intel:${tagnumber} ."
                                                sh "docker build -f build/dockerfile -t 31147669.dkr.ecr.us-east-1.amazonaws.com/ss01-prod-maxapi-${tagname}-arm32:${tagnumber} ."
                                               sh "docker images"
                                           }
                                        }
                                    //}
                                }
                            }
                        }
                    }
                    post{
                        always{
                            cleanWs()
                        }
                    }
                }
            }
        }
    }
}